{% extends "base.html" %}

{% block title %}Paiements - VoyagesDZ{% endblock %}

{% block content %}
<div class="vz-page-head">
    <div>
        <h2>üí≥ Paiements</h2>
        <p style="color: var(--text-muted);">Gestion des paiements</p>
    </div>
    <div class="vz-actions">
        {% if current_user.has_role('MANAGER_DEPT') or current_user.has_role('DIRECTOR_SITE') or current_user.has_role('GENERAL_DIRECTOR') %}
        <a href="{{ url_for('payments.create') }}" class="vz-btn vz-primary">
            + Nouveau Paiement
        </a>
        {% endif %}
    </div>
</div>

<hr>

<!-- Statistiques -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 24px;">
    <div style="background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 18px;">
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Total Paiements</div>
        <div style="font-size: 28px; font-weight: 800;">{{ stats.total }}</div>
    </div>
    <div style="background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 18px;">
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Compl√©t√©s</div>
        <div style="font-size: 28px; font-weight: 800; color: #4ade80;">{{ stats.completed }}</div>
    </div>
    <div style="background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 18px;">
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">En Attente</div>
        <div style="font-size: 28px; font-weight: 800; color: #fb923c;">{{ stats.pending }}</div>
    </div>
    <div style="background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 18px;">
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">√âchou√©s</div>
        <div style="font-size: 28px; font-weight: 800; color: #ef4444;">{{ stats.failed }}</div>
    </div>
</div>

<!-- Montant total -->
<div style="background: linear-gradient(135deg, var(--rose-deep), var(--rose-main)); color: #fff; border-radius: 14px; padding: 20px; margin-bottom: 24px;">
    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Montant Total Trait√©</div>
    <div style="font-size: 36px; font-weight: 900;">{{ "{:,.2f}".format(stats.total_amount) if stats.total_amount else "0.00" }} DZD</div>
</div>

<!-- Table -->
<div style="background: #fff; border: 1px solid var(--line); border-radius: 14px; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: var(--rose-deep); color: #fff;">
            <tr>
                <th style="padding: 12px; text-align: left; font-weight: 600;">R√©f√©rence</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">R√©servation</th>
                <th style="padding: 12px; text-align: right; font-weight: 600;">Montant</th>
                <th style="padding: 12px; text-align: center; font-weight: 600;">M√©thode</th>
                <th style="padding: 12px; text-align: center; font-weight: 600;">Statut</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">Date</th>
                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payments %}
            <tr style="border-bottom: 1px solid var(--line); transition: background 0.15s;">
                <td style="padding: 12px; font-weight: 600; font-family: monospace;">{{ payment.transaction_reference }}</td>
                <td style="padding: 12px; color: var(--text-muted);">
                    {% if payment.booking %}
                        <a href="{{ url_for('bookings.detail', booking_id=payment.booking.id) }}" 
                           style="color: var(--rose-deep); text-decoration: none; font-weight: 600;">
                            {{ payment.booking.booking_reference }}
                        </a>
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: right; font-weight: 700;">{{ "{:,.2f}".format(payment.amount_dzd) }} DZD</td>
                <td style="padding: 12px; text-align: center;">
                    {% if payment.payment_method == 'CARD' %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #dbeafe; color: #1e40af; font-size: 12px; font-weight: 600;">üí≥ Carte</span>
                    {% elif payment.payment_method == 'CASH' %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #dcfce7; color: #15803d; font-size: 12px; font-weight: 600;">üíµ Esp√®ces</span>
                    {% elif payment.payment_method == 'TRANSFER' %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #fef3c7; color: #92400e; font-size: 12px; font-weight: 600;">üè¶ Virement</span>
                    {% else %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #f3f4f6; color: #374151; font-size: 12px; font-weight: 600;">{{ payment.payment_method }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: center;">
                    {% if payment.status == 'COMPLETED' or payment.status == 'completed' %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #dcfce7; color: #15803d; font-size: 12px; font-weight: 600;">‚úì Compl√©t√©</span>
                    {% elif payment.status == 'PENDING' or payment.status == 'pending' %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #fed7aa; color: #9a3412; font-size: 12px; font-weight: 600;">‚è≥ En attente</span>
                    {% elif payment.status == 'FAILED' or payment.status == 'failed' %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #fecaca; color: #991b1b; font-size: 12px; font-weight: 600;">‚úó √âchou√©</span>
                    {% else %}
                        <span style="padding: 4px 10px; border-radius: 999px; background: #f3f4f6; color: #374151; font-size: 12px; font-weight: 600;">{{ payment.status }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; color: var(--text-muted); font-size: 13px;">
                    {{ payment.payment_date.strftime('%d/%m/%Y %H:%M') if payment.payment_date else 'N/A' }}
                </td>
                <td style="padding: 12px; text-align: center;">
                    <a href="{{ url_for('payments.detail', payment_id=payment.id) }}" 
                       style="display: inline-block; padding: 6px 12px; border-radius: 8px; background: var(--rose-main); color: #fff; text-decoration: none; font-size: 13px; font-weight: 600;">
                        Voir
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="padding: 40px; text-align: center; color: var(--text-muted);">
                    Aucun paiement disponible
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<div style="display: flex; justify-content: center; gap: 8px; margin-top: 20px;">
    {% if pagination.has_prev %}
    <a href="{{ url_for('payments.list', page=pagination.prev_num) }}" 
       style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--line); background: #fff; text-decoration: none; color: var(--text-main); font-weight: 600;">
        ‚Üê Pr√©c√©dent
    </a>
    {% endif %}
    
    <span style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--line); background: var(--rose-main); color: #fff; font-weight: 600;">
        Page {{ pagination.page }} / {{ pagination.pages }}
    </span>
    
    {% if pagination.has_next %}
    <a href="{{ url_for('payments.list', page=pagination.next_num) }}" 
       style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--line); background: #fff; text-decoration: none; color: var(--text-main); font-weight: 600;">
        Suivant ‚Üí
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}